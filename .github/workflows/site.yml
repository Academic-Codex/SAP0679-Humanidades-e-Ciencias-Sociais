---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build & Publish (gh-pages)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  repository_dispatch:
    types: [ template-updated ] 

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Repo da disciplina (Aulas/, .scripts/, etc.)
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) Baixa o template global
      - name: Checkout template global
        uses: actions/checkout@v4
        with:
          repository: Academic-Codex/academic-codex.github.io
          path: template-global

      # 3) Coloca o template no caminho que o build_site.py espera (./template)
      - name: Prepare template folder
        run: |
          rm -rf template
          mkdir -p template
          rsync -a --delete \
            template-global/.github/actions/build-template-site/template/ \
            template/

      # 4) Python + nbconvert
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 5) Converte notebooks
      - name: Install nbconvert + deps
        run: |
          python -m pip install --upgrade pip
          pip install nbconvert jupyter jupyterlab_pygments pygments

      # 6) Baixa a imagem hero do reposit√≥rio global e injeta no template local (./template)
      - name: Fetch hero image (single file, raw.githubusercontent)
        shell: bash
        run: |
          set -euo pipefail

          BASE_RAW="https://raw.githubusercontent.com/Academic-Codex/academic-codex.github.io/main"

          # L√™ ASSETS_SUBDIR e HERO_FILE do seu .scripts/codex.yml
          python - <<'PY' > hero_relpath.txt
          import yaml, sys
          from pathlib import Path
          d = {}
          p = Path(".scripts/codex.yml")
          if p.exists():
              d = yaml.safe_load(p.read_text(encoding="utf-8")) or {}
          sub = (d.get("ASSETS_SUBDIR") or "img/portfolio").strip("/")
          fil = (d.get("HERO_FILE") or "").strip("/")
          if not fil:
              sys.exit("HERO_FILE ausente em .scripts/codex.yml")
          print(f"{sub}/{fil}")
          PY

              HERO_REL=$(cat hero_relpath.txt)
              HERO_URL="$BASE_RAW/$HERO_REL"

              echo "Baixando hero: $HERO_URL"
              mkdir -p template/assets
              curl -fsSL "$HERO_URL" -o template/assets/hero.jpg

              # Substitui o placeholder do template por caminho local
              sed -i.bak 's#{{ *HERO_URL *}}#./assets/hero.jpg#g' template/index.html


      # 7) Build do site a partir dos notebooks
      - name: Build static site
        run: |
          set -euxo pipefail
          rm -rf site
          python .scripts/build_site.py \
            --src . \
            --out site \
            --template template \
            --title "${{ github.repository }}" \
            --cfg .scripts/codex.yml \
            --execute false

          # detecta o arquivo hero baixado e renomeia para hero.png
          HERO_SRC=$(find template/assets -maxdepth 1 -type f -name "hero.*" -o -name "*.jpg" -o -name "*.png" | head -n 1 || true)

          if [ -z "$HERO_SRC" ]; then
            echo "‚ö†Ô∏è  Nenhuma imagem hero encontrada em template/assets/"
          else
            mkdir -p site/assets/img
            echo "üì∏ Copiando $HERO_SRC ‚Üí site/assets/img/hero.png"
            cp "$HERO_SRC" site/assets/img/hero.png
          fi

      # 8) Diagn√≥stico: mostrar o que ser√° publicado
      - name: Show site tree
        run: |
          echo "== ls -R site =="
          ls -lah site || true
          echo "== find site -maxdepth 3 -type f =="
          find site -maxdepth 3 -type f | sort

      # 9) Publica em gh-pages (cria/atualiza branch)
      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages