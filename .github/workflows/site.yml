---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build & Publish (gh-pages)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) checkout do repositório da disciplina
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) checkout do template global (no caminho template-global/)
      - name: Checkout template global
        uses: actions/checkout@v4
        with:
          repository: Academic-Codex/academic-codex.github.io
          path: template-global

      # 3) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4) Instalar nbconvert + deps (HTML não precisa de pandoc)
      - name: Install nbconvert + deps
        run: |
          python -m pip install --upgrade pip
          pip install nbconvert jupyter jupyterlab_pygments pygments

      # 5) Converter notebooks e montar site/ com o seu script
      - name: Build static site from notebooks
        run: |
          python .github/scripts/build_site.py \
            --src Aulas \
            --out site \
            --template template-global/.github/actions/build-template-site/template \
            --title "${{ github.repository }}" \
            --execute false

      # 6) Publicar em gh-pages (cria/atualiza a branch para você)
      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages