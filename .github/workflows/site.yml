---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build & Publish (gh-pages)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Repo da disciplina (Aulas/, .scripts/, etc.)
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) Baixa o template global
      - name: Checkout template global
        uses: actions/checkout@v4
        with:
          repository: Academic-Codex/academic-codex.github.io
          path: template-global

      # 3) Coloca o template no caminho que o build_site.py espera (./template)
      - name: Prepare template folder
        run: |
          rm -rf template
          mkdir -p template
          rsync -a --delete \
            template-global/.github/actions/build-template-site/template/ \
            template/

      # 4) Python + nbconvert
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install nbconvert + deps
        run: |
          python -m pip install --upgrade pip
          pip install nbconvert jupyter jupyterlab_pygments pygments

      # 5) Build do site a partir dos notebooks
      - name: Build static site from notebooks
        run: |
          set -euxo pipefail
          rm -rf site
          python .scripts/build_site.py \
            --src . \
            --out site \
            --template template \
            --title "${{ github.repository }}" \
            --execute false

      # 6) Diagnóstico: mostrar o que será publicado
      - name: Show site tree
        run: |
          echo "== ls -R site =="
          ls -lah site || true
          echo "== find site -maxdepth 3 -type f =="
          find site -maxdepth 3 -type f | sort

      # 7) Publica em gh-pages (cria/atualiza branch)
      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages